<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Motor Monitor</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .card { border:1px solid #ddd; border-radius:10px; padding:12px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: left; }
    th { font-weight: 600; }
    code { background:#f6f6f6; padding:2px 6px; border-radius:6px; }
    .pill { display:inline-block; padding:2px 10px; border-radius:999px; border:1px solid #ddd; }
    .muted { color:#666; font-size: 0.95rem; }
    .ok { }
    .warn { }
    .crit { }
  </style>
</head>
<body>
  <div class="row">
    <h2 style="margin:0;">Smart Motor Monitor</h2>
    <span class="pill">ESP32 â†’ MQTT â†’ Postgres â†’ API</span>
  </div>

  <div class="row" style="margin-top:10px;">
    <div class="card">
      <div><b>Refresh</b></div>
      <div class="row">
        <label>cada <input id="refreshSec" type="number" value="5" min="1" style="width:70px;"> s</label>
        <button id="btnRefresh">Refrescar ahora</button>
      </div>
      <div class="muted" id="lastUpdate">â€”</div>
    </div>

    <div class="card">
      <div><b>Reglas de estado</b></div>
      <div class="muted">temp_c: warn â‰¥ 35 | crit â‰¥ 45</div>
      <div class="muted">vib_rms: warn â‰¥ 0.60 | crit â‰¥ 0.85</div>
    </div>
  </div>

  <h3 style="margin-top:18px;">Dispositivos</h3>

  <table>
    <thead>
      <tr>
        <th>Estado</th>
        <th>Device</th>
        <th>ts_ingest</th>
        <th>RSSI</th>
        <th>Temp (Â°C)</th>
        <th>Vib (RMS)</th>
        <th>Raw</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="7" class="muted">Cargandoâ€¦</td></tr>
    </tbody>
  </table>

  <script>
    const API = ""; // mismo host (FastAPI)
    const tbody = document.getElementById("tbody");
    const lastUpdate = document.getElementById("lastUpdate");
    const refreshSec = document.getElementById("refreshSec");
    const btnRefresh = document.getElementById("btnRefresh");

    function statusFrom(payload) {
      const t = payload?.temp_c;
      const v = payload?.vib_rms;

      const tCrit = (typeof t === "number" && t >= 45);
      const tWarn = (typeof t === "number" && t >= 35);

      const vCrit = (typeof v === "number" && v >= 0.85);
      const vWarn = (typeof v === "number" && v >= 0.60);

      if (tCrit || vCrit) return "ðŸ”´";
      if (tWarn || vWarn) return "ðŸŸ¡";
      return "ðŸŸ¢";
    }

    async function getJSON(path) {
      const res = await fetch(API + path);
      if (!res.ok) throw new Error(`${path} -> ${res.status}`);
      return await res.json();
    }

    function fmt(val) {
      if (val === null || val === undefined) return "â€”";
      if (typeof val === "number") return val.toFixed(2);
      return String(val);
    }

    async function refresh() {
        try {
            tbody.innerHTML = `<tr><td colspan="7" class="muted">Actualizandoâ€¦</td></tr>`;

            const res = await getJSON("/telemetry/latest_all?limit_devices=200");
            const items = (res && res.items) ? res.items : [];

            if (items.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="muted">No hay datos todavÃ­a.</td></tr>`;
            lastUpdate.textContent = "Ãšltima actualizaciÃ³n: " + new Date().toLocaleString();
            return;
            }

            const rows = items.map(item => {
            const d = item.device_id || "unknown";
            const p = item.payload || {};
            const st = statusFrom(p);

            return `
                <tr>
                <td>${st}</td>
                <td><code>${d}</code></td>
                <td>${item.ts_ingest || "â€”"}</td>
                <td>${fmt(p.rssi)}</td>
                <td>${fmt(p.temp_c)}</td>
                <td>${fmt(p.vib_rms)}</td>
                <td class="muted"><code>${JSON.stringify(p)}</code></td>
                </tr>
            `;
            });

            tbody.innerHTML = rows.join("");
            lastUpdate.textContent = "Ãšltima actualizaciÃ³n: " + new Date().toLocaleString();
        } catch (e) {
            tbody.innerHTML = `<tr><td colspan="7" class="muted">Error: ${e.message}</td></tr>`;
        }
    }


    let timer = null;
    function schedule() {
      if (timer) clearInterval(timer);
      const s = Math.max(1, parseInt(refreshSec.value || "5", 10));
      timer = setInterval(refresh, s * 1000);
    }

    btnRefresh.addEventListener("click", refresh);
    refreshSec.addEventListener("change", schedule);

    refresh();
    schedule();
  </script>
</body>
</html>
